<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stealth Approach</title>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #222;
            color: white;
            touch-action: manipulation;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100%;
            overflow: hidden;
        }

        #game-area {
            position: relative;
            width: 100%;
            height: 85%;
            background-color: #332255;
            background-size: cover;
            transition: background-color 0.5s;
        }

        /* Path design */
        .game-path {
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            width: 120px;
            height: 100%;
            background-color: rgba(60, 40, 30, 0.6);
            border-left: 3px solid rgba(255, 255, 255, 0.2);
            border-right: 3px solid rgba(255, 255, 255, 0.2);
            z-index: 1;
        }

        .path-tile {
            position: absolute;
            width: 100%;
            height: 40px;
            background: repeating-linear-gradient(90deg,
                    rgba(60, 40, 30, 0.8),
                    rgba(70, 50, 40, 0.8) 20px);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        #progress-bar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            z-index: 10;
        }

        #progress {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #4CAF50;
            transition: height 0.2s;
        }

        #monster {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            border-radius: 10px;
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            /* Жуткое свечение */
            animation: pulse 2s infinite alternate;
            z-index: 5;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            }

            100% {
                box-shadow: 0 0 25px rgba(255, 0, 0, 0.8);
            }
        }

        /* Пульсирующее тело */
        @keyframes monsterBreathing {
            0% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.05);
            }

            100% {
                transform: translateX(-50%) scale(1);
            }
        }

        .monster-eye {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
            overflow: hidden;
        }

        .monster-eye-left {
            top: 25px;
            left: 20px;
            animation: blinkLeft 8s infinite;
        }

        .monster-eye-right {
            top: 25px;
            right: 20px;
            animation: blinkRight 8s infinite;
        }

        @keyframes blinkLeft {

            0%,
            95%,
            97% {
                transform: scaleY(1);
            }

            96%,
            98% {
                transform: scaleY(0.1);
            }
        }

        @keyframes blinkRight {

            0%,
            92%,
            94% {
                transform: scaleY(1);
            }

            93%,
            95% {
                transform: scaleY(0.1);
            }
        }

        .monster-pupil {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: black;
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: transform 0.3s;
            animation: lookAround 5s infinite;
        }

        @keyframes lookAround {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(2px, 2px);
            }

            50% {
                transform: translate(-2px, 1px);
            }

            75% {
                transform: translate(1px, -2px);
            }
        }

        .monster-mouth {
            position: absolute;
            width: 40px;
            height: 12px;
            background-color: #333;
            border-radius: 10px 10px 20px 20px;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            transition: height 0.3s, width 0.3s;
            overflow: hidden;
        }

        .monster-teeth {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            display: flex;
            justify-content: space-around;
        }

        .monster-tooth {
            width: 4px;
            height: 4px;
            background-color: #fff;
            border-radius: 0 0 2px 2px;
        }

        .monster-tongue {
            position: absolute;
            width: 20px;
            height: 10px;
            background-color: #ff3366;
            border-radius: 10px;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            animation: tongueMove 3s infinite;
        }

        @keyframes tongueMove {

            0%,
            100% {
                transform: translateX(-50%) scaleY(0.5);
            }

            50% {
                transform: translateX(-50%) scaleY(1);
            }
        }

        #monster-vision {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            width: 340px;
            height: 850px;
            background: linear-gradient(to bottom, rgba(231, 76, 60, 0.3), rgba(231, 76, 60, 0.1));
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: visionPulse 4s infinite alternate;
            z-index: 4;
        }

        @keyframes visionPulse {
            0% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        .shaking {
            animation: shake 0.1s infinite !important;
        }

        @keyframes shake {
            0% {
                transform: translateX(-50%) translateY(0) scale(1.2);
            }

            25% {
                transform: translateX(-51%) translateY(1px) scale(1.2);
            }

            50% {
                transform: translateX(-50%) translateY(0) scale(1.2);
            }

            75% {
                transform: translateX(-49%) translateY(-1px) scale(1.2);
            }

            100% {
                transform: translateX(-50%) translateY(0) scale(1.2);
            }
        }

        #monster-sleep-text {
            position: absolute;
            top: -8px;
            right: 10px;
            font-family: 'Comic Sans MS', sans-serif;
            font-weight: bold;
            color: white;
            font-size: 24px;
            opacity: 0;
            transform: translateY(0);
            transition: opacity 0.5s;
            z-index: 100;
        }

        .z-letter {
            position: relative;
            display: inline-block;
            animation-name: float-z;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        @keyframes float-z {
            0% {
                transform: translateY(0) rotate(0);
            }

            50% {
                transform: translateY(-10px) rotate(5deg);
            }

            100% {
                transform: translateY(0) rotate(0);
            }
        }

        .z1 {
            animation-delay: 0s;
        }

        .z2 {
            animation-delay: 0.3s;
        }

        .z3 {
            animation-delay: 0.6s;
        }

        #player {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 60px;
            background-color: #3498db;
            border-radius: 50% 50% 0 0;
            transition: transform 0.3s, bottom 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 5;
        }

        .player-head {
            width: 30px;
            height: 30px;
            background-color: #f5d76e;
            border-radius: 50%;
            position: relative;
            top: -10px;
        }

        .player-eye {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #333;
            border-radius: 50%;
            top: 10px;
        }

        .player-eye-left {
            left: 8px;
        }

        .player-eye-right {
            right: 8px;
        }

        .player-foot {
            position: absolute;
            width: 15px;
            height: 8px;
            background-color: #2980b9;
            border-radius: 5px;
            bottom: 0;
            transition: transform 0.3s;
        }

        .player-foot-left {
            left: 5px;
            transform-origin: top left;
        }

        .player-foot-right {
            right: 5px;
            transform-origin: top right;
        }

        /* Капли пота */
        .sweat-drop {
            position: absolute;
            width: 6px;
            height: 10px;
            background-color: rgba(173, 216, 230, 0.8);
            border-radius: 50% 50% 50% 50%;
            opacity: 0;
            transition: opacity 0.5s, transform 1s;
        }

        .sweat-drop-left {
            top: 5px;
            left: -5px;
            transform: rotate(-15deg);
        }

        .sweat-drop-right {
            top: 5px;
            right: -5px;
            transform: rotate(15deg);
        }

        /* Анимация для пота */
        .scared .sweat-drop {
            opacity: 1;
            transform: translateY(15px) rotate(-15deg);
        }

        .scared .sweat-drop-right {
            transform: translateY(15px) rotate(15deg);
        }

        /* Дрожание для испуганного персонажа */
        @keyframes shake {

            0%,
            100% {
                transform: translateX(-50%) rotate(0deg);
            }

            25% {
                transform: translateX(-50%) rotate(-1deg);
            }

            75% {
                transform: translateX(-50%) rotate(1deg);
            }
        }


        .scared {
            animation: shake 0.3s infinite;
        }

        #button-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 15%;
            background-color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        /* Improved step button styling */
        #action-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border: none;
            font-size: 22px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3),
                inset 0 2px 3px rgba(255, 255, 255, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            outline: none;
            position: relative;
            overflow: hidden;
        }

        #action-button:before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0) 100%);
            transition: left 0.5s;
        }

        #action-button:hover:before {
            left: 100%;
        }

        #action-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, #c0392b, #e74c3c);
        }

        #stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: right;
            z-index: 10;
        }

        .coins {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: gold;
            border-radius: 50%;
            opacity: 0;
            transition: transform 1s, opacity 1s;
            z-index: 10;
        }

        #menu-buttons {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .menu-button {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            margin-right: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .menu-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        #level-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            z-index: 100;
        }

        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            z-index: 100;
        }

        #restart-button {
            padding: 10px 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }

        .points {
            position: absolute;
            font-size: 22px;
            color: yellow;
            opacity: 0;
            transition: opacity 0.3s, transform 1s;
            z-index: 15;
        }

        /* Modal window styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: #34495e;
            color: white;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.5rem;
            margin: 0;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .primary-button {
            background-color: #3498db;
            color: white;
        }

        .secondary-button {
            background-color: #95a5a6;
            color: white;
        }

        /* Environment elements */
        .torch {
            position: absolute;
            width: 10px;
            height: 30px;
            background-color: #543;
            z-index: 3;
        }

        .torch:after {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 10px;
            height: 15px;
            background: radial-gradient(ellipse at center, #ff7, #f50);
            border-radius: 50% 50% 25% 25%;
            box-shadow: 0 0 20px #fa0, 0 0 40px #fd0;
            animation: flicker 0.5s infinite alternate;
        }

        @keyframes flicker {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(0.98);
                opacity: 0.8;
            }
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div id="game-area">
            <!-- Environment elements -->
            <div class="game-path"></div>

            <!-- Add path tiles to create the path -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const gamePath = document.querySelector('.game-path');
                    const pathHeight = gamePath.offsetHeight;
                    const tileHeight = 40;
                    const tileCount = Math.ceil(pathHeight / tileHeight);

                    for (let i = 0; i < tileCount; i++) {
                        const tile = document.createElement('div');
                        tile.className = 'path-tile';
                        tile.style.bottom = (i * tileHeight) + 'px';
                        gamePath.appendChild(tile);
                    }

                    const torchPositions = [200, 400, 600];
                    torchPositions.forEach((pos) => {
                        // Left torch
                        const leftTorch = document.createElement('div');
                        leftTorch.className = 'torch';
                        leftTorch.style.position = 'absolute';
                        leftTorch.style.left = '-40px';
                        leftTorch.style.bottom = (pathHeight - pos) + 'px'; // Convert top position to bottom position

                        // Right torch
                        const rightTorch = document.createElement('div');
                        rightTorch.className = 'torch';
                        rightTorch.style.position = 'absolute';
                        rightTorch.style.right = '-40px';
                        rightTorch.style.bottom = (pathHeight - pos) + 'px'; // Convert top position to bottom position

                        gamePath.appendChild(leftTorch);
                        gamePath.appendChild(rightTorch);
                    });

                });
            </script>

            <div id="progress-bar">
                <div id="progress"></div>
            </div>

            <div id="monster">
                <div class="monster-eye monster-eye-left">
                    <div class="monster-pupil"></div>
                </div>
                <div class="monster-eye monster-eye-right">
                    <div class="monster-pupil"></div>
                </div>
                <div class="monster-mouth">
                    <div class="monster-teeth">
                        <div class="monster-tooth"></div>
                        <div class="monster-tooth"></div>
                        <div class="monster-tooth"></div>
                        <div class="monster-tooth"></div>
                        <div class="monster-tooth"></div>
                    </div>
                    <div class="monster-tongue"></div>
                </div>
                <div id="monster-vision"></div>
                <div id="monster-sleep-text">
                    <span class="z-letter z1">Z</span>
                    <span class="z-letter z2">z</span>
                    <span class="z-letter z3">z</span>
                </div>
            </div>

            <div id="player">
                <div class="player-head">
                    <div class="player-eye player-eye-left"></div>
                    <div class="player-eye player-eye-right"></div>
                </div>
                <div class="player-foot player-foot-left"></div>
                <div class="player-foot player-foot-right"></div>
            </div>

            <div id="stats">
                <div>Score: <span id="score">0</span></div>
                <div>Coins: <span id="coins">0</span></div>
                <div>Level: <span id="level">1</span></div>
            </div>

            <div id="menu-buttons">
                <button class="menu-button" id="restart">Restart</button>
                <button class="menu-button" id="pause">Pause</button>
                <button class="menu-button" id="settings">Settings</button>
                <button class="menu-button" id="help">Help</button>
            </div>

            <div id="level-info">
                <h2>Level <span id="level-number">1</span></h2>
                <p id="level-desc">Sneak past the guardian monster!</p>
            </div>
        </div>

        <div id="button-area">
            <button id="action-button">STEP</button>
        </div>

        <div id="game-over">
            <h1>Game Over!</h1>
            <p>The monster caught you!</p>
            <p>Final Score: <span id="final-score">0</span></p>
            <button id="restart-button">Restart Game</button>
        </div>

        <!-- Modal windows -->
        <div class="modal" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Settings</h2>
                    <button class="close-button" data-close-modal>&times;</button>
                </div>
                <div class="modal-body">
                    <p>Adjust game settings:</p>
                    <div style="margin: 15px 0;">
                        <label for="sound-toggle">Sound Effects:</label>
                        <input type="checkbox" id="sound-toggle" checked>
                    </div>
                    <div style="margin: 15px 0;">
                        <label for="difficulty">Difficulty:</label>
                        <select id="difficulty">
                            <option value="easy">Easy</option>
                            <option value="normal" selected>Normal</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-button secondary-button" data-close-modal>Cancel</button>
                    <button class="modal-button primary-button" id="save-settings">Save</button>
                </div>
            </div>
        </div>

        <div class="modal" id="help-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">How to Play</h2>
                    <button class="close-button" data-close-modal>&times;</button>
                </div>
                <div class="modal-body">
                    <p>Welcome to Stealth Approach!</p>
                    <ul style="text-align: left; padding-left: 20px;">
                        <li>Press the STEP button to move forward</li>
                        <li>Only move when the monster is sleeping (Zzzz)</li>
                        <li>If you move while the monster is awake, you'll be caught!</li>
                        <li>Complete each level to progress to more challenging guardians</li>
                        <li>Earn points by successfully sneaking past monsters</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="modal-button primary-button" data-close-modal>Got it!</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Game variables
        let gameState = {
            level: 1,
            score: 0,
            coins: 0,
            stepsNeeded: 10,
            currentSteps: 0,
            monsterAwake: false,
            paused: false,
            gameOver: false,
            soundEnabled: true,
            difficulty: 'normal',
            monsterPatterns: [
                { sleepTime: 3000, awakeTime: 1500 },  // Level 1
                { sleepTime: 2500, awakeTime: 1800 },  // Level 2
                { sleepTime: 2000, awakeTime: 2000 },  // Level 3
                { sleepTime: 1500, awakeTime: 2200 },  // Level 4
                { sleepTime: 1000, awakeTime: 2500 }   // Level 5
            ],
            backgrounds: [
                '#332255',  // Level 1 - Deep purple
                '#553322',  // Level 2 - Brown
                '#225533',  // Level 3 - Teal
                '#552233',  // Level 4 - Burgundy
                '#335522'   // Level 5 - Olive green
            ],
            monsters: [
                '#ff0000',  // Level 1 - Red
                '#ff6600',  // Level 2 - Orange
                '#cc00ff',  // Level 3 - Purple
                '#00ccff',  // Level 4 - Blue
                '#ffcc00'   // Level 5 - Yellow
            ],
            levelDescriptions: [
                "Sneak past the sleeping guardian!",
                "This monster is more alert. Be careful!",
                "Halfway there! This one has keen senses.",
                "Almost there! This guardian rarely sleeps.",
                "Final challenge! The ultimate guardian never truly sleeps."
            ]
        };

        // DOM elements
        const gameArea = document.getElementById('game-area');
        const progressBar = document.getElementById('progress');
        const monster = document.getElementById('monster');
        const monsterEyes = document.querySelectorAll('.monster-pupil');
        const monsterMouth = document.querySelector('.monster-mouth');
        const player = document.getElementById('player');
        const playerFeetLeft = document.querySelector('.player-foot-left');
        const playerFeetRight = document.querySelector('.player-foot-right');
        const actionButton = document.getElementById('action-button');
        const scoreElement = document.getElementById('score');
        const coinsElement = document.getElementById('coins');
        const levelElement = document.getElementById('level');
        const restartButton = document.getElementById('restart');
        const pauseButton = document.getElementById('pause');
        const settingsButton = document.getElementById('settings');
        const helpButton = document.getElementById('help');
        const levelInfo = document.getElementById('level-info');
        const levelNumber = document.getElementById('level-number');
        const levelDesc = document.getElementById('level-desc');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreElement = document.getElementById('final-score');
        const restartGameButton = document.getElementById('restart-button');
        const monsterVision = document.getElementById('monster-vision');
        const monsterSleepText = document.getElementById('monster-sleep-text');
        const settingsModal = document.getElementById('settings-modal');
        const helpModal = document.getElementById('help-modal');
        const soundToggle = document.getElementById('sound-toggle');
        const difficultySelect = document.getElementById('difficulty');
        const saveSettingsButton = document.getElementById('save-settings');

        // Monster behavior timer
        let monsterTimer;
        let stepCount = 0;

        // Modals management
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            gameState.paused = true;
        }

        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.classList.remove('show');
            });
            if (!gameState.gameOver) {
                gameState.paused = false;
            }
        }

        // Initialize the game
        function initGame() {
            gameState.level = 1;
            gameState.score = 0;
            gameState.coins = 0;
            gameState.stepsNeeded = 10;
            gameState.currentSteps = 0;
            gameState.monsterAwake = false;
            gameState.paused = false;
            gameState.gameOver = false;

            updateUI();
            startMonsterBehavior();
            showLevelInfo();

            // Initialize environment based on level
            updateEnvironment();
        }

        // Update environment based on level
        function updateEnvironment() {
            // Update path color based on level
            const levelIndex = Math.min(gameState.level - 1, gameState.backgrounds.length - 1);
            const pathTiles = document.querySelectorAll('.path-tile');

            pathTiles.forEach(tile => {
                switch (levelIndex) {
                    case 0: // Level 1
                        tile.style.background = 'repeating-linear-gradient(90deg, rgba(60, 40, 30, 0.8), rgba(70, 50, 40, 0.8) 20px)';
                        break;
                    case 1: // Level 2
                        tile.style.background = 'repeating-linear-gradient(90deg, rgba(50, 40, 70, 0.8), rgba(60, 50, 80, 0.8) 20px)';
                        break;
                    case 2: // Level 3
                        tile.style.background = 'repeating-linear-gradient(90deg, rgba(40, 60, 50, 0.8), rgba(50, 70, 60, 0.8) 20px)';
                        break;
                    case 3: // Level 4
                        tile.style.background = 'repeating-linear-gradient(90deg, rgba(65, 35, 45, 0.8), rgba(75, 45, 55, 0.8) 20px)';
                        break;
                    case 4: // Level 5
                        tile.style.background = 'repeating-linear-gradient(90deg, rgba(50, 60, 30, 0.8), rgba(60, 70, 40, 0.8) 20px)';
                        break;
                }
            });
        }

        // Update UI elements
        function updateUI() {
            // Update stats
            scoreElement.textContent = gameState.score;
            coinsElement.textContent = gameState.coins;
            levelElement.textContent = gameState.level;

            // Update progress bar
            const progressPercentage = (gameState.currentSteps / gameState.stepsNeeded) * 100;
            progressBar.style.height = `${progressPercentage}%`;

            // Update level visuals
            const levelIndex = Math.min(gameState.level - 1, gameState.backgrounds.length - 1);
            gameArea.style.backgroundColor = gameState.backgrounds[levelIndex];
            monster.style.backgroundColor = gameState.monsters[levelIndex];
        }

        // Функция для активации режима страха
        function showFear(duration = 3000) {
            const player = document.getElementById('player');

            // Добавляем капли пота, если их еще нет
            if (!document.querySelector('.sweat-drop')) {
                const sweatDropLeft = document.createElement('div');
                sweatDropLeft.className = 'sweat-drop sweat-drop-left';

                const sweatDropRight = document.createElement('div');
                sweatDropRight.className = 'sweat-drop sweat-drop-right';

                player.querySelector('.player-head').appendChild(sweatDropLeft);
                player.querySelector('.player-head').appendChild(sweatDropRight);
            }

            // Добавляем класс для испуганного вида
            player.classList.add('scared');

            // Возвращаем нормальное выражение через указанное время
            if (duration) {
                setTimeout(() => {
                    player.classList.remove('scared');
                }, duration);
            }

            return {
                stopFear: function () {
                    player.classList.remove('scared');
                }
            };
        }

        // Start monster behavior pattern
        function startMonsterBehavior() {
            if (monsterTimer) clearInterval(monsterTimer);

            const levelIndex = Math.min(gameState.level - 1, gameState.monsterPatterns.length - 1);
            let pattern = gameState.monsterPatterns[levelIndex];

            // Adjust timing based on difficulty
            if (gameState.difficulty === 'easy') {
                pattern = {
                    sleepTime: pattern.sleepTime * 1.3,
                    awakeTime: pattern.awakeTime * 0.7
                };
            } else if (gameState.difficulty === 'hard') {
                pattern = {
                    sleepTime: pattern.sleepTime * 0.7,
                    awakeTime: pattern.awakeTime * 1.3
                };
            }

            monsterTimer = setInterval(() => {
                if (gameState.paused || gameState.gameOver) return;

                if (gameState.monsterAwake) {
                    // Monster going to sleep
                    gameState.monsterAwake = false;
                    monsterSleep();

                    setTimeout(() => {
                        if (!gameState.paused && !gameState.gameOver) {
                            // Monster waking up
                            gameState.monsterAwake = true;
                            monsterWake();
                        }
                    }, pattern.sleepTime);
                }
            }, pattern.sleepTime + pattern.awakeTime);

            // Start with monster sleeping
            gameState.monsterAwake = false;
            monsterSleep();

            setTimeout(() => {
                if (!gameState.paused && !gameState.gameOver) {
                    gameState.monsterAwake = true;
                    monsterWake();
                }
            }, pattern.sleepTime);
        }

        // Monster sleep animation
        function monsterSleep() {
            const player = document.getElementById('player');

            // Остановить дыхательную анимацию и начать анимацию сна
            monster.style.animation = 'none';
            setTimeout(() => { monster.style.animation = 'pulse 2s infinite alternate'; }, 10);

            monster.style.transform = 'translateX(-50%) scale(1)';
            monster.style.filter = 'brightness(0.7)';

            // Eyes close
            monsterEyes.forEach(eye => {
                eye.style.animation = 'none';
                eye.style.transform = 'scaleY(0.1)';
            });

            // Mouth relaxes
            monsterMouth.style.height = '2px';
            monsterMouth.style.width = '20px';
            monsterMouth.style.backgroundColor = '#222';

            // Скрыть зубы и язык
            document.querySelector('.monster-teeth').style.display = 'none';
            document.querySelector('.monster-tongue').style.display = 'none';

            monsterVision.style.display = 'none';
            monsterSleepText.style.opacity = '1';
            player.classList.remove('scared');

            // Play sleep sound if enabled
            if (gameState.soundEnabled) {
                // Play sleep sound (placeholder)
                // sleepSound.play();
            }
        }

        // Monster wake animation
        function monsterWake() {
            monster.style.animation = 'monsterBreathing 2s infinite';
            monster.style.transform = 'translateX(-50%) scale(1.2)';
            monster.style.filter = 'brightness(1.2)';

            // Eyes open wide with angry animation
            monsterEyes.forEach((eye, index) => {
                eye.style.animation = index === 0 ? 'blinkLeft 8s infinite' : 'blinkRight 8s infinite';
                eye.style.transform = 'scale(1.2)';
            });

            // Pupils look around rapidly
            document.querySelectorAll('.monster-pupil').forEach(pupil => {
                pupil.style.animation = 'lookAround 2s infinite';
            });

            // Mouth opens with teeth and tongue
            monsterMouth.style.height = '15px';
            monsterMouth.style.width = '40px';
            monsterMouth.style.borderRadius = '10px 10px 20px 20px';
            monsterMouth.style.backgroundColor = '#333';

            // Показать зубы и язык
            document.querySelector('.monster-teeth').style.display = 'flex';
            document.querySelector('.monster-tongue').style.display = 'block';

            // Пульсирующее видение
            monsterVision.style.display = 'block';
            monsterVision.style.animation = 'visionPulse 2s infinite alternate';

            monsterSleepText.style.opacity = '0';
            showFear();

            // Добавить эффект дрожания для большего страха
            monster.classList.add('shaking');
            setTimeout(() => { monster.classList.remove('shaking'); }, 2000);

            // Play wake sound if enabled
            if (gameState.soundEnabled) {
                // Play wake sound (placeholder)
                // wakeSound.play();
            }
        }

        // Player step animation
        function animateStep() {
            stepCount++;

            if (stepCount % 2 === 0) {
                playerFeetLeft.style.transform = 'rotate(-20deg)';
                playerFeetRight.style.transform = 'rotate(0deg)';
            } else {
                playerFeetLeft.style.transform = 'rotate(0deg)';
                playerFeetRight.style.transform = 'rotate(20deg)';
            }

            // Play step sound if enabled
            if (gameState.soundEnabled) {
                // Play step sound (placeholder)
                // stepSound.play();
            }
        }

        // Player step action
        function playerStep() {
            if (gameState.paused || gameState.gameOver) return;

            if (gameState.monsterAwake) {
                // Player got caught
                endGame();
                return;
            }

            // Successful step
            gameState.currentSteps++;

            // Move player closer to monster
            const progressPercentage = gameState.currentSteps / gameState.stepsNeeded;
            player.style.bottom = `${150 - (progressPercentage * 100)}px`;

            // Visual feedback
            player.style.transform = 'translateX(-50%) scale(1.1)';
            animateStep();
            addPoints(Math.floor(Math.random() * 10) + 1);

            setTimeout(() => {
                player.style.transform = 'translateX(-50%) scale(1)';
            }, 100);

            updateUI();

            // Check if level completed
            if (gameState.currentSteps >= gameState.stepsNeeded) {
                completeLevel();
            }
        }

        // Add points indicator
        function addPoints(amount, sourceElement = null) {
            const pointsElement = document.createElement('div');
            pointsElement.className = 'points';
            pointsElement.textContent = '+' + amount;

            if (sourceElement) {
                const rect = sourceElement.getBoundingClientRect();
                pointsElement.style.left = (rect.left + rect.width / 2) + 'px';
                pointsElement.style.top = rect.top + 'px';
            } else {
                pointsElement.style.left = (Math.random() * (window.innerWidth - 100) + 50) + 'px';
                pointsElement.style.top = (Math.random() * (window.innerHeight / 2) + 200) + 'px';
            }

            document.body.appendChild(pointsElement);

            // Animate
            setTimeout(() => {
                pointsElement.style.opacity = '1';
                pointsElement.style.transform = 'translateY(-50px)';
            }, 10);

            setTimeout(() => {
                pointsElement.style.opacity = '0';
            }, 800);

            setTimeout(() => {
                pointsElement.remove();
            }, 1000);

            // Update score
            gameState.score += amount;
        }

        // Complete current level
        function completeLevel() {
            clearInterval(monsterTimer);
            monsterSleepText.style.opacity = '0';
            gameState.paused = true;

            // Monster defeated animation
            monster.style.transform = 'translateX(-50%) scale(0.8) rotate(180deg)';
            monster.style.opacity = '0.5';
            monsterMouth.style.height = '2px';

            // Coin drop animation
            const coinCount = 5 + gameState.level * 2;
            for (let i = 0; i < coinCount; i++) {
                const coin = document.createElement('div');
                coin.className = 'coins';

                // Position coin near monster
                const monsterRect = monster.getBoundingClientRect();
                const randomOffsetX = Math.random() * 80 - 40;
                const randomOffsetY = Math.random() * 40 - 20;

                coin.style.left = `${monsterRect.left + monsterRect.width / 2 + randomOffsetX}px`;
                coin.style.top = `${monsterRect.top + monsterRect.height / 2 + randomOffsetY}px`;

                gameArea.appendChild(coin);

                // Animate coin
                setTimeout(() => {
                    coin.style.opacity = '1';
                    coin.style.transform = `translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 + 50}px)`;
                }, i * 50);

                // Remove coin after animation
                setTimeout(() => {
                    coin.remove();
                }, 1500);
            }

            // Add coins and bonus points
            const levelBonus = gameState.level * 50;
            gameState.score += levelBonus;
            gameState.coins += coinCount;

            updateUI();

            // Play level complete sound if enabled
            if (gameState.soundEnabled) {
                // Play level complete sound (placeholder)
                // levelCompleteSound.play();
            }

            // Start next level after delay
            setTimeout(() => {
                gameState.level++;
                gameState.currentSteps = 0;
                gameState.stepsNeeded = 10 + (gameState.level - 1) * 5;
                if (gameState.stepsNeeded > 30) gameState.stepsNeeded = 30;

                gameState.paused = false;

                // Reset player and monster
                player.style.bottom = '150px';
                monster.style.transform = 'translateX(-50%) scale(1)';
                monster.style.opacity = '1';
                monster.style.rotate = '0deg';

                updateUI();
                updateEnvironment();
                startMonsterBehavior();
                showLevelInfo();
            }, 2000);
        }

        // Show level information
        function showLevelInfo() {
            levelNumber.textContent = gameState.level;
            const levelIndex = Math.min(gameState.level - 1, gameState.levelDescriptions.length - 1);
            levelDesc.textContent = gameState.levelDescriptions[levelIndex];

            levelInfo.style.opacity = '1';

            setTimeout(() => {
                levelInfo.style.opacity = '0';
            }, 2000);
        }

        // End the game
        function endGame() {
            gameState.gameOver = true;
            clearInterval(monsterTimer);

            // Monster catching player animation
            monster.style.transform = 'translateX(-50%) scale(1.5)';
            monsterMouth.style.height = '25px';
            monsterMouth.style.width = '50px';

            player.style.opacity = '0.5';
            player.style.transform = 'translateX(-50%) scale(0.8) rotate(180deg)';

            // Play game over sound if enabled
            if (gameState.soundEnabled) {
                // Play game over sound (placeholder)
                // gameOverSound.play();
            }

            // Show game over screen
            finalScoreElement.textContent = gameState.score;
            gameOverScreen.style.opacity = '1';
            gameOverScreen.style.pointerEvents = 'auto';
        }

        // Toggle pause state
        function togglePause() {
            gameState.paused = !gameState.paused;
            pauseButton.textContent = gameState.paused ? 'Resume' : 'Pause';

            if (!gameState.paused) {
                // Resume monster behavior
                startMonsterBehavior();
            }
        }

        // Restart the game
        function restartGame() {
            clearInterval(monsterTimer);
            gameOverScreen.style.opacity = '0';
            gameOverScreen.style.pointerEvents = 'none';

            // Reset player and monster
            player.style.bottom = '150px';
            player.style.opacity = '1';
            player.style.transform = 'translateX(-50%) scale(1)';
            playerFeetLeft.style.transform = 'rotate(0deg)';
            playerFeetRight.style.transform = 'rotate(0deg)';

            monster.style.transform = 'translateX(-50%) scale(1)';
            monster.style.opacity = '1';
            monsterMouth.style.height = '8px';
            monsterMouth.style.width = '40px';

            initGame();
        }

        // Save settings
        function saveSettings() {
            gameState.soundEnabled = soundToggle.checked;
            gameState.difficulty = difficultySelect.value;

            // If game is in progress, update monster behavior for new difficulty
            if (!gameState.gameOver) {
                startMonsterBehavior();
            }

            closeAllModals();
        }

        // Event listeners
        actionButton.addEventListener('click', playerStep);
        restartButton.addEventListener('click', restartGame);
        pauseButton.addEventListener('click', togglePause);
        restartGameButton.addEventListener('click', restartGame);
        settingsButton.addEventListener('click', () => openModal('settings-modal'));
        helpButton.addEventListener('click', () => openModal('help-modal'));
        saveSettingsButton.addEventListener('click', saveSettings);

        // Close modal when clicking close buttons
        document.querySelectorAll('[data-close-modal]').forEach(button => {
            button.addEventListener('click', closeAllModals);
        });

        // Touch events optimization for mobile
        actionButton.addEventListener('touchstart', function (e) {
            e.preventDefault();
            playerStep();
        });

        // Initialize the game on load
        window.addEventListener('load', initGame);
    </script>
</body>

</html>
