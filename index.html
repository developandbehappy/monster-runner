<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stealth Approach</title>
    <style>
        /* Базовые стили и сброс */
        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #222;
            color: white;
            touch-action: manipulation;
        }

        /* Контейнеры */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100%;
            overflow: hidden;
        }

        #game-area {
            position: relative;
            width: 100%;
            height: 85%;
            background-color: #332255;
            background-size: cover;
            transition: background-color 0.5s;
        }

        /* Общие позиционированные элементы */
        .centered-element {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Путь и его элементы */
        .game-path {
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            width: 220px;
            height: 100%;
            background-color: rgba(60, 40, 30, 0.8);
            z-index: 1;
        }

        .path-tile {
            position: absolute;
            width: 100%;
            height: 40px;
            background: repeating-linear-gradient(90deg,
                    rgba(60, 40, 30, 0.8),
                    rgba(70, 50, 40, 0.8) 20px);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* Панель прогресса */
        #progress-bar {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60%;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            z-index: 10;
        }

        #progress {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #4CAF50;
            transition: height 0.2s;
        }

        #monster-container {
            position: absolute;
            left: 50%;
            top: 50px;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            z-index: 3;
        }

        #monster {
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            border-radius: 10px;
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            animation: pulse 2s infinite alternate;
            z-index: 5;
        }

        #monster-vision {
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            width: 340px;
            height: 850px;
            background: linear-gradient(to bottom, rgba(231, 76, 60, 0.3), rgba(231, 76, 60, 0.1));
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: visionPulse 4s infinite alternate;
            z-index: 2;
        }

        /* Глаза монстра */
        .monster-eye {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
            overflow: hidden;
        }

        .monster-eye-left {
            top: 25px;
            left: 20px;
            animation: blinkLeft 8s infinite;
        }

        .monster-eye-right {
            top: 25px;
            right: 20px;
            animation: blinkRight 8s infinite;
        }

        .monster-pupil {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: black;
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: transform 0.3s;
            animation: lookAround 5s infinite;
        }

        /* Рот монстра */
        .monster-mouth {
            position: absolute;
            width: 40px;
            height: 12px;
            background-color: #333;
            border-radius: 10px 10px 20px 20px;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            transition: height 0.3s, width 0.3s;
            overflow: hidden;
        }

        .monster-teeth {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            display: flex;
            justify-content: space-around;
        }

        .monster-tooth {
            width: 4px;
            height: 4px;
            background-color: #fff;
            border-radius: 0 0 2px 2px;
        }

        .monster-tongue {
            position: absolute;
            width: 20px;
            height: 10px;
            background-color: #ff3366;
            border-radius: 10px;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            animation: tongueMove 3s infinite;
        }

        /* Текст "сон" монстра */
        #monster-sleep-text {
            position: absolute;
            top: -8px;
            right: 10px;
            font-family: 'Comic Sans MS', sans-serif;
            font-weight: bold;
            color: white;
            font-size: 24px;
            opacity: 0;
            transform: translateY(0);
            transition: opacity 0.5s;
            z-index: 100;
        }

        .z-letter {
            position: relative;
            display: inline-block;
            animation-name: float-z;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .z1 {
            animation-delay: 0s;
        }

        .z2 {
            animation-delay: 0.3s;
        }

        .z3 {
            animation-delay: 0.6s;
        }

        /* Игрок и его компоненты */
        #player {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 60px;
            background-color: #3498db;
            border-radius: 50% 50% 0 0;
            transition: transform 0.3s, bottom 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 5;
        }

        .player-head {
            width: 30px;
            height: 30px;
            background-color: #f5d76e;
            border-radius: 50%;
            position: relative;
            top: -10px;
        }

        .player-eye {
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #333;
            border-radius: 50%;
            top: 10px;
        }

        .player-eye-left {
            left: 8px;
        }

        .player-eye-right {
            right: 8px;
        }

        .player-foot {
            position: absolute;
            width: 15px;
            height: 8px;
            background-color: #2980b9;
            border-radius: 5px;
            bottom: 0;
            transition: transform 0.3s;
        }

        .player-foot-left {
            left: 5px;
            transform-origin: top left;
        }

        .player-foot-right {
            right: 5px;
            transform-origin: top right;
        }

        /* Капли пота */
        .sweat-drop {
            position: absolute;
            width: 6px;
            height: 10px;
            background-color: rgba(173, 216, 230, 0.8);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.5s, transform 1s;
        }

        .sweat-drop-left {
            top: 5px;
            left: -5px;
            transform: rotate(-15deg);
        }

        .sweat-drop-right {
            top: 5px;
            right: -5px;
            transform: rotate(15deg);
        }

        /* Страх игрока */
        .scared .sweat-drop {
            opacity: 1;
        }

        .scared .sweat-drop-left {
            transform: translateY(15px) rotate(-15deg);
        }

        .scared .sweat-drop-right {
            transform: translateY(15px) rotate(15deg);
        }

        .scared {
            animation: shake 0.3s infinite;
        }

        /* UI элементы */
        #button-area {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 15%;
            background-color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0px -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        #action-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e74c3c, #c0392b);
            border: none;
            font-size: 22px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3),
                inset 0 2px 3px rgba(255, 255, 255, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
            outline: none;
            position: relative;
            overflow: hidden;
        }

        #action-button:before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.2) 50%,
                    rgba(255, 255, 255, 0) 100%);
            transition: left 0.5s;
        }

        #action-button:hover:before {
            left: 100%;
        }

        #action-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(145deg, #c0392b, #e74c3c);
        }

        /* Статистика и меню */
        #stats {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            /* Сделаем более непрозрачным */
            padding: 10px 15px;
            border-radius: 10px;
            text-align: right;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            /* Добавляем тень */
        }

        #menu-buttons {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .menu-button {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            margin-right: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .menu-button:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        /* Информационные окна и модальные окна */
        #level-info,
        #game-over {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 100;
        }

        #level-info {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            pointer-events: none;
        }

        #game-over {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        #restart-button {
            padding: 10px 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }

        /* Анимированные объекты (монеты/очки) */
        .coins {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: gold;
            border-radius: 50%;
            opacity: 0;
            transition: transform 1s, opacity 1s;
            z-index: 10;
        }

        .points {
            position: absolute;
            font-size: 22px;
            color: yellow;
            opacity: 0;
            transition: opacity 0.3s, transform 1s;
            z-index: 15;
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: #34495e;
            color: white;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.5rem;
            margin: 0;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .primary-button {
            background-color: #3498db;
            color: white;
        }

        .secondary-button {
            background-color: #95a5a6;
            color: white;
        }

        /* Окружающие элементы */
        .torch {
            position: absolute;
            width: 10px;
            height: 30px;
            background-color: #543;
            z-index: 3;
        }

        .torch:after {
            content: "";
            position: absolute;
            top: -10px;
            left: 0;
            width: 10px;
            height: 15px;
            background: radial-gradient(ellipse at center, #ff7, #f50);
            border-radius: 50% 50% 25% 25%;
            box-shadow: 0 0 20px #fa0, 0 0 40px #fd0;
            animation: flicker 0.5s infinite alternate;
        }

        /* Анимации - объединены и оптимизированы */
        @keyframes pulse {
            0% {
                box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
            }

            100% {
                box-shadow: 0 0 25px rgba(255, 0, 0, 0.8);
            }
        }

        @keyframes monsterBreathing {
            0% {
                transform: translateX(-50%) scale(1);
            }

            50% {
                transform: translateX(-50%) scale(1.05);
            }

            100% {
                transform: translateX(-50%) scale(1);
            }
        }

        @keyframes blinkLeft {

            0%,
            95%,
            97% {
                transform: scaleY(1);
            }

            96%,
            98% {
                transform: scaleY(0.1);
            }
        }

        @keyframes blinkRight {

            0%,
            92%,
            94% {
                transform: scaleY(1);
            }

            93%,
            95% {
                transform: scaleY(0.1);
            }
        }

        @keyframes lookAround {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(2px, 2px);
            }

            50% {
                transform: translate(-2px, 1px);
            }

            75% {
                transform: translate(1px, -2px);
            }
        }

        @keyframes tongueMove {

            0%,
            100% {
                transform: translateX(-50%) scaleY(0.5);
            }

            50% {
                transform: translateX(-50%) scaleY(1);
            }
        }

        @keyframes visionPulse {
            0% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(-50%) rotate(0deg);
            }

            25% {
                transform: translateX(-50%) rotate(-1deg);
            }

            75% {
                transform: translateX(-50%) rotate(1deg);
            }
        }

        @keyframes float-z {
            0% {
                transform: translateY(0) rotate(0);
            }

            50% {
                transform: translateY(-10px) rotate(5deg);
            }

            100% {
                transform: translateY(0) rotate(0);
            }
        }

        @keyframes flicker {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(0.98);
                opacity: 0.8;
            }
        }
    </style>
</head>

<body>
    <div id="game-container">
        <div id="game-area">
            <!-- Environment elements -->
            <div class="game-path"></div>

            <!-- Add path tiles to create the path -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const gamePath = document.querySelector('.game-path');
                    const pathHeight = gamePath.offsetHeight;
                    const tileHeight = 40;
                    const tileCount = Math.ceil(pathHeight / tileHeight);

                    // Создаем плитки пола в виде шахматной доски для лучшей видимости движения
                    for (let i = 0; i < tileCount; i++) {
                        const tile = document.createElement('div');
                        tile.className = 'path-tile';
                        tile.style.bottom = (i * tileHeight) + 'px';

                        // Чередуем два оттенка для создания эффекта плитки
                        const isDarkTile = i % 2 === 0;
                        tile.style.backgroundColor = isDarkTile ? 'rgba(50, 35, 25, 0.8)' : 'rgba(60, 45, 35, 0.8)';

                        // Добавляем простую рамку для лучшего эффекта
                        tile.style.borderTop = '1px solid rgba(255, 255, 255, 0.1)';

                        gamePath.appendChild(tile);
                    }

                });
            </script>

            <div id="progress-bar">
                <div id="progress"></div>
            </div>

            <div id="monster-container">
                <div id="monster-vision"></div>
                <div id="monster">
                    <div class="monster-eye monster-eye-left">
                        <div class="monster-pupil"></div>
                    </div>
                    <div class="monster-eye monster-eye-right">
                        <div class="monster-pupil"></div>
                    </div>
                    <div class="monster-mouth">
                        <div class="monster-teeth">
                            <div class="monster-tooth"></div>
                            <div class="monster-tooth"></div>
                            <div class="monster-tooth"></div>
                            <div class="monster-tooth"></div>
                            <div class="monster-tooth"></div>
                        </div>
                        <div class="monster-tongue"></div>
                    </div>
                    <div id="monster-sleep-text">
                        <span class="z-letter z1">Z</span>
                        <span class="z-letter z2">z</span>
                        <span class="z-letter z3">z</span>
                    </div>
                </div>
            </div>

            <div id="player">
                <div class="player-head">
                    <div class="player-eye player-eye-left"></div>
                    <div class="player-eye player-eye-right"></div>
                </div>
                <div class="player-foot player-foot-left"></div>
                <div class="player-foot player-foot-right"></div>
            </div>

            <div id="stats">
                <div>Score: <span id="score">0</span></div>
                <div>Coins: <span id="coins">0</span></div>
                <div>Level: <span id="level">1</span></div>
            </div>

            <div id="menu-buttons">
                <button class="menu-button" id="restart">Restart</button>
                <button class="menu-button" id="pause">Pause</button>
                <button class="menu-button" id="settings">Settings</button>
                <button class="menu-button" id="help">Help</button>
            </div>

            <div id="level-info">
                <h2>Level <span id="level-number">1</span></h2>
                <p id="level-desc">Sneak past the guardian monster!</p>
            </div>
        </div>

        <div id="button-area">
            <button id="action-button">STEP</button>
        </div>

        <div id="game-over">
            <h1>Game Over!</h1>
            <p>The monster caught you!</p>
            <p>Final Score: <span id="final-score">0</span></p>
            <button id="restart-button">Restart Game</button>
        </div>

        <!-- Modal windows -->
        <div class="modal" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Settings</h2>
                    <button class="close-button" data-close-modal>&times;</button>
                </div>
                <div class="modal-body">
                    <p>Adjust game settings:</p>
                    <div style="margin: 15px 0;">
                        <label for="background-toggle">Use Background Images:</label>
                        <input type="checkbox" id="background-toggle" checked>
                    </div>
                    <div style="margin: 15px 0;">
                        <label for="sound-toggle">Sound Effects:</label>
                        <input type="checkbox" id="sound-toggle" checked>
                    </div>
                    <div style="margin: 15px 0;">
                        <label for="difficulty">Difficulty:</label>
                        <select id="difficulty">
                            <option value="easy">Easy</option>
                            <option value="normal" selected>Normal</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-button secondary-button" data-close-modal>Cancel</button>
                    <button class="modal-button primary-button" id="save-settings">Save</button>
                </div>
            </div>
        </div>

        <div class="modal" id="help-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">How to Play</h2>
                    <button class="close-button" data-close-modal>&times;</button>
                </div>
                <div class="modal-body">
                    <p>Welcome to Stealth Approach!</p>
                    <ul style="text-align: left; padding-left: 20px;">
                        <li>Press the STEP button to move forward</li>
                        <li>Only move when the monster is sleeping (Zzzz)</li>
                        <li>If you move while the monster is awake, you'll be caught!</li>
                        <li>Complete each level to progress to more challenging guardians</li>
                        <li>Earn points by successfully sneaking past monsters</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button class="modal-button primary-button" data-close-modal>Got it!</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        /**
 * Monster Runner Game
 * Оптимизированная версия игры с улучшенными анимациями для мобильных устройств
 */

        // ======= Анимационный движок =======
        class AnimationEngine {
            constructor() {
                this.animations = new Map();
                this.nextId = 1;
            }

            /**
             * Создаёт плавную анимацию дрожания элемента
             * @param {HTMLElement} element - Элемент для анимации
             * @param {Object} options - Параметры анимации
             * @return {Object} - Контроллер анимации
             */
            shake(element, options = {}) {
                // Настройки по умолчанию
                const settings = {
                    intensity: options.intensity || 1,  // Интенсивность дрожания
                    frequency: options.frequency || 0.1, // Частота колебаний
                    duration: options.duration || null,  // Длительность (null = бесконечно)
                    baseTransform: options.baseTransform || 'translateX(-50%)', // Начальная трансформация
                    axis: options.axis || 'rotate',  // Тип анимации ('rotate', 'translateX', 'translateY')
                    onComplete: options.onComplete || null // Колбэк по завершении
                };

                // Остановить существующие анимации для элемента
                this.stop(element);

                // Сохраняем исходные стили
                const originalStyles = {
                    transform: element.style.transform || '',
                    transition: element.style.transition || '',
                    animation: element.style.animation || ''
                };

                // Отключаем CSS анимации
                element.style.animation = 'none';
                element.style.transition = 'none';

                // Переменные для анимации
                const startTime = performance.now();
                let lastFrameTime = startTime;
                let animationId = null;

                // Функция обновления кадра анимации
                const updateFrame = (currentTime) => {
                    // Получаем временной интервал для плавности анимации
                    const deltaTime = currentTime - lastFrameTime;
                    lastFrameTime = currentTime;
                    const elapsed = currentTime - startTime;

                    // Расчет значения для более естественного движения
                    const phase = elapsed * settings.frequency;
                    const amplitude = Math.sin(phase) * settings.intensity;

                    // Применяем трансформацию в зависимости от типа оси
                    let transform = settings.baseTransform;
                    switch (settings.axis) {
                        case 'rotate':
                            transform += ` rotate(${amplitude}deg)`;
                            break;
                        case 'translateX':
                            transform += ` translateX(${amplitude}px)`;
                            break;
                        case 'translateY':
                            transform += ` translateY(${amplitude}px)`;
                            break;
                    }
                    element.style.transform = transform;

                    // Проверяем, не истекло ли время анимации
                    if (settings.duration && elapsed >= settings.duration) {
                        this.stop(element);
                        element.style.transform = settings.baseTransform;
                        if (typeof settings.onComplete === 'function') {
                            settings.onComplete();
                        }
                        return;
                    }

                    // Запрашиваем следующий кадр
                    animationId = requestAnimationFrame(updateFrame);
                };

                // Создаем уникальный ID и контроллер анимации
                const id = this._generateId();
                const controller = {
                    id,
                    originalStyles,
                    element,
                    stop: () => this.stop(element)
                };

                // Сохраняем контроллер и запускаем анимацию
                this.animations.set(element, controller);
                animationId = requestAnimationFrame(updateFrame);

                return controller;
            }

            /**
             * Создает анимацию пульсации элемента
             * @param {HTMLElement} element - Элемент для анимации
             * @param {Object} options - Параметры анимации
             * @return {Object} - Контроллер анимации
             */
            pulse(element, options = {}) {
                const settings = {
                    minScale: options.minScale || 0.95,
                    maxScale: options.maxScale || 1.05,
                    duration: options.duration || null,
                    interval: options.interval || 1000,
                    baseTransform: options.baseTransform || 'translateX(-50%)',
                    onComplete: options.onComplete || null
                };

                this.stop(element);

                const originalStyles = {
                    transform: element.style.transform || '',
                    transition: element.style.transition || '',
                    animation: element.style.animation || ''
                };

                element.style.animation = 'none';
                element.style.transition = 'none';

                const startTime = performance.now();
                let direction = 1; // 1 = увеличение, -1 = уменьшение
                let currentScale = 1;
                let animationId = null;

                const updateFrame = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const phase = (elapsed % settings.interval) / settings.interval;

                    // Плавное изменение масштаба с использованием синусоиды
                    currentScale = settings.minScale + (settings.maxScale - settings.minScale) *
                        (Math.sin(phase * Math.PI * 2 - Math.PI / 2) + 1) / 2;

                    element.style.transform = `${settings.baseTransform} scale(${currentScale})`;

                    // Проверяем, не истекло ли время анимации
                    if (settings.duration && elapsed >= settings.duration) {
                        this.stop(element);
                        element.style.transform = settings.baseTransform;
                        if (typeof settings.onComplete === 'function') {
                            settings.onComplete();
                        }
                        return;
                    }

                    animationId = requestAnimationFrame(updateFrame);
                };

                const id = this._generateId();
                const controller = {
                    id,
                    originalStyles,
                    element,
                    stop: () => this.stop(element)
                };

                this.animations.set(element, controller);
                animationId = requestAnimationFrame(updateFrame);

                return controller;
            }

            /**
             * Останавливает анимацию для элемента
             * @param {HTMLElement} element - Элемент
             */
            stop(element) {
                if (this.animations.has(element)) {
                    const controller = this.animations.get(element);

                    // Восстанавливаем оригинальные стили
                    element.style.animation = controller.originalStyles.animation;
                    element.style.transition = controller.originalStyles.transition;

                    this.animations.delete(element);
                }
            }

            /**
             * Останавливает все анимации
             */
            stopAll() {
                this.animations.forEach((controller, element) => {
                    this.stop(element);
                });
            }

            /**
             * Генерирует уникальный ID для анимации
             * @private
             * @return {number} Уникальный ID
             */
            _generateId() {
                return this.nextId++;
            }
        }

        /**
         * Класс управления игрой Monster Runner
         */
        class MonsterRunnerGame {
            constructor() {
                // Состояние игры
                this.state = {
                    level: 1,
                    score: 0,
                    coins: 0,
                    stepsNeeded: 10,
                    currentSteps: 0,
                    monsterAwake: false,
                    paused: false,
                    gameOver: false,
                    soundEnabled: true,
                    difficulty: 'normal',
                    monsterPatterns: [
                        { sleepTime: 3000, awakeTime: 1500 },  // Level 1
                        { sleepTime: 2500, awakeTime: 1800 },  // Level 2
                        { sleepTime: 2000, awakeTime: 2000 },  // Level 3
                        { sleepTime: 1500, awakeTime: 2200 },  // Level 4
                        { sleepTime: 1000, awakeTime: 2500 }   // Level 5
                    ],
                    backgrounds: [
                        '#332255',  // Level 1 - Deep purple
                        '#553322',  // Level 2 - Brown
                        '#225533',  // Level 3 - Teal
                        '#552233',  // Level 4 - Burgundy
                        '#335522'   // Level 5 - Olive green
                    ],
                    backgroundImages: [
                        './loc.jpeg',  // Лес
                        './loc1.jpeg',  // Пещера
                        './loc3.jpeg',  // Ночной город
                        'https://images.unsplash.com/photo-1518290409845-94397e8a431d?auto=format&fit=crop&w=1200&q=80',  // Руины
                        'https://images.unsplash.com/photo-1518070588484-2b53926cba76?auto=format&fit=crop&w=1200&q=80'   // Замок
                    ],
                    monsters: [
                        '#ff0000',  // Level 1 - Red
                        '#ff6600',  // Level 2 - Orange
                        '#cc00ff',  // Level 3 - Purple
                        '#00ccff',  // Level 4 - Blue
                        '#ffcc00'   // Level 5 - Yellow
                    ],
                    levelDescriptions: [
                        "Sneak past the sleeping guardian!",
                        "This monster is more alert. Be careful!",
                        "Halfway there! This one has keen senses.",
                        "Almost there! This guardian rarely sleeps.",
                        "Final challenge! The ultimate guardian never truly sleeps."
                    ]
                };

                // Таймеры и анимации
                this.monsterTimer = null;
                this.stepCount = 0;
                this.activeAnimations = {};

                // Инициализация движка анимаций
                this.animationEngine = new AnimationEngine();
            }

            /**
             * Инициализация игры
             */
            init() {
                // Получение DOM элементов
                this.elements = {
                    gameArea: document.getElementById('game-area'),
                    progressBar: document.getElementById('progress'),
                    monster: document.getElementById('monster'),
                    monsterContainer: document.getElementById('monster-container'),
                    monsterEyes: document.querySelectorAll('.monster-pupil'),
                    monsterMouth: document.querySelector('.monster-mouth'),
                    player: document.getElementById('player'),
                    playerFeetLeft: document.querySelector('.player-foot-left'),
                    playerFeetRight: document.querySelector('.player-foot-right'),
                    actionButton: document.getElementById('action-button'),
                    scoreElement: document.getElementById('score'),
                    coinsElement: document.getElementById('coins'),
                    levelElement: document.getElementById('level'),
                    restartButton: document.getElementById('restart'),
                    pauseButton: document.getElementById('pause'),
                    settingsButton: document.getElementById('settings'),
                    helpButton: document.getElementById('help'),
                    levelInfo: document.getElementById('level-info'),
                    levelNumber: document.getElementById('level-number'),
                    levelDesc: document.getElementById('level-desc'),
                    gameOverScreen: document.getElementById('game-over'),
                    finalScoreElement: document.getElementById('final-score'),
                    restartGameButton: document.getElementById('restart-button'),
                    monsterVision: document.getElementById('monster-vision'),
                    monsterSleepText: document.getElementById('monster-sleep-text'),
                    settingsModal: document.getElementById('settings-modal'),
                    helpModal: document.getElementById('help-modal'),
                    soundToggle: document.getElementById('sound-toggle'),
                    difficultySelect: document.getElementById('difficulty'),
                    saveSettingsButton: document.getElementById('save-settings')
                };

                // Привязка обработчиков событий
                this._bindEvents();

                // Инициализация состояния игры
                this._resetGameState();
                this._updateUI();
                this._startMonsterBehavior();
                this._showLevelInfo();
                this._updateEnvironment();
            }

            /**
             * Привязка обработчиков событий
             * @private
             */
            _bindEvents() {
                // Основные элементы управления
                this.elements.actionButton.addEventListener('click', () => this._playerStep());
                this.elements.restartButton.addEventListener('click', () => this._restartGame());
                this.elements.pauseButton.addEventListener('click', () => this._togglePause());
                this.elements.restartGameButton.addEventListener('click', () => this._restartGame());
                this.elements.settingsButton.addEventListener('click', () => this._openModal('settings-modal'));
                this.elements.helpButton.addEventListener('click', () => this._openModal('help-modal'));
                this.elements.saveSettingsButton.addEventListener('click', () => this._saveSettings());

                // Закрытие модальных окон
                document.querySelectorAll('[data-close-modal]').forEach(button => {
                    button.addEventListener('click', () => this._closeAllModals());
                });

                // Оптимизация для мобильных устройств
                this.elements.actionButton.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this._playerStep();
                });
            }

            /**
             * Сброс состояния игры
             * @private
             */
            _resetGameState() {
                this.state.level = 1;
                this.state.score = 0;
                this.state.coins = 0;
                this.state.stepsNeeded = 10;
                this.state.currentSteps = 0;
                this.state.monsterAwake = false;
                this.state.paused = false;
                this.state.gameOver = false;
            }

            /**
             * Обновление UI элементов игры
             * @private
             */
            _updateUI() {
                // Обновление статистики
                this.elements.scoreElement.textContent = this.state.score;
                this.elements.coinsElement.textContent = this.state.coins;
                this.elements.levelElement.textContent = this.state.level;

                // Обновление прогрессбара
                const progressPercentage = (this.state.currentSteps / this.state.stepsNeeded) * 100;
                this.elements.progressBar.style.height = `${progressPercentage}%`;

                // Обновление визуальных стилей уровня
                const levelIndex = Math.min(this.state.level - 1, this.state.backgrounds.length - 1);

                // Устанавливаем фоновое изображение вместо цвета
                if (this.state.backgroundImages && this.state.backgroundImages.length > 0) {
                    const bgImage = this.state.backgroundImages[levelIndex];
                    this.elements.gameArea.style.backgroundColor = ''; // Убираем цвет фона
                    this.elements.gameArea.style.backgroundImage = `url(${bgImage})`;
                    this.elements.gameArea.style.backgroundSize = 'cover';
                    this.elements.gameArea.style.backgroundPosition = 'center';
                } else {
                    // Запасной вариант с цветным фоном
                    this.elements.gameArea.style.backgroundImage = '';
                    this.elements.gameArea.style.backgroundColor = this.state.backgrounds[levelIndex];
                }

                this.elements.monster.style.backgroundColor = this.state.monsters[levelIndex];
            }

            /**
             * Обновление элементов окружения в соответствии с текущим уровнем
             * @private
             */
            _updateEnvironment() {
                // Обновление стиля дорожки в зависимости от уровня
                const levelIndex = Math.min(this.state.level - 1, this.state.backgrounds.length - 1);
                const pathTiles = document.querySelectorAll('.path-tile');

                let tileStyle;
                switch (levelIndex) {
                    case 0: // Level 1
                        tileStyle = 'repeating-linear-gradient(90deg, rgba(60, 40, 30, 0.8), rgba(70, 50, 40, 0.8) 20px)';
                        break;
                    case 1: // Level 2
                        tileStyle = 'repeating-linear-gradient(90deg, rgba(50, 40, 70, 0.8), rgba(60, 50, 80, 0.8) 20px)';
                        break;
                    case 2: // Level 3
                        tileStyle = 'repeating-linear-gradient(90deg, rgba(40, 60, 50, 0.8), rgba(50, 70, 60, 0.8) 20px)';
                        break;
                    case 3: // Level 4
                        tileStyle = 'repeating-linear-gradient(90deg, rgba(65, 35, 45, 0.8), rgba(75, 45, 55, 0.8) 20px)';
                        break;
                    case 4: // Level 5
                        tileStyle = 'repeating-linear-gradient(90deg, rgba(50, 60, 30, 0.8), rgba(60, 70, 40, 0.8) 20px)';
                        break;
                }

                pathTiles.forEach(tile => {
                    tile.style.background = tileStyle;
                });
            }

            /**
             * Запуск поведения монстра
             * @private
             */
            _startMonsterBehavior() {
                // Остановка существующего таймера
                if (this.monsterTimer) {
                    clearInterval(this.monsterTimer);
                }

                // Получение паттерна поведения монстра в зависимости от уровня
                const levelIndex = Math.min(this.state.level - 1, this.state.monsterPatterns.length - 1);
                let pattern = { ...this.state.monsterPatterns[levelIndex] };

                // Корректировка тайминга в зависимости от сложности
                if (this.state.difficulty === 'easy') {
                    pattern.sleepTime *= 1.3;
                    pattern.awakeTime *= 0.7;
                } else if (this.state.difficulty === 'hard') {
                    pattern.sleepTime *= 0.7;
                    pattern.awakeTime *= 1.3;
                }

                // Запуск цикла поведения
                this.monsterTimer = setInterval(() => {
                    if (this.state.paused || this.state.gameOver) return;

                    if (this.state.monsterAwake) {
                        // Монстр засыпает
                        this.state.monsterAwake = false;
                        this._monsterSleep();

                        setTimeout(() => {
                            if (!this.state.paused && !this.state.gameOver) {
                                // Монстр просыпается
                                this.state.monsterAwake = true;
                                this._monsterWake();
                            }
                        }, pattern.sleepTime);
                    }
                }, pattern.sleepTime + pattern.awakeTime);

                // Начинаем со спящего монстра
                this.state.monsterAwake = false;
                this._monsterSleep();

                setTimeout(() => {
                    if (!this.state.paused && !this.state.gameOver) {
                        this.state.monsterAwake = true;
                        this._monsterWake();
                    }
                }, pattern.sleepTime);
            }

            /**
             * Анимация спящего монстра
             * @private
             */
            _monsterSleep() {
                // Остановка всех активных анимаций монстра
                if (this.activeAnimations.monsterShaking) {
                    this.activeAnimations.monsterShaking.stop();
                    delete this.activeAnimations.monsterShaking;
                }
                if (this.activeAnimations.monsterPulsing) {
                    this.activeAnimations.monsterPulsing.stop();
                    delete this.activeAnimations.monsterPulsing;
                }

                // Анимация пульсации спящего монстра
                this.activeAnimations.monsterPulsing = this.animationEngine.pulse(this.elements.monsterContainer, {
                    minScale: 0.98,
                    maxScale: 1.02,
                    interval: 2000,
                    baseTransform: 'translateX(-50%)'
                });

                // Визуальные эффекты
                this.elements.monster.style.filter = 'brightness(0.7)';

                // Глаза закрываются
                this.elements.monsterEyes.forEach(eye => {
                    eye.style.animation = 'none';
                    eye.style.transform = 'scaleY(0.1)';
                });

                // Рот расслабляется
                this.elements.monsterMouth.style.height = '2px';
                this.elements.monsterMouth.style.width = '20px';
                this.elements.monsterMouth.style.backgroundColor = '#222';

                // Скрыть зубы и язык
                document.querySelector('.monster-teeth').style.display = 'none';
                document.querySelector('.monster-tongue').style.display = 'none';

                // Отключаем обзор монстра и отображаем zZZ
                this.elements.monsterVision.style.display = 'none';
                this.elements.monsterSleepText.style.opacity = '1';

                // Убираем страх с игрока
                this._stopFear();

                // Воспроизведение звука если включено
                if (this.state.soundEnabled) {
                    // this._playSound('sleep');
                }
            }

            /**
             * Анимация просыпающегося монстра
             * @private
             */
            _monsterWake() {
                // Остановка всех активных анимаций монстра
                if (this.activeAnimations.monsterPulsing) {
                    this.activeAnimations.monsterPulsing.stop();
                    delete this.activeAnimations.monsterPulsing;
                }

                // Анимация дыхания активного монстра
                this.elements.monster.style.animation = 'monsterBreathing 2s infinite';
                this.elements.monster.style.transform = 'translateX(-50%) scale(1.2)';
                this.elements.monster.style.filter = 'brightness(1.2)';

                // Глаза открываются широко
                this.elements.monsterEyes.forEach((eye, index) => {
                    eye.style.animation = index === 0 ? 'blinkLeft 8s infinite' : 'blinkRight 8s infinite';
                    eye.style.transform = 'scale(1.2)';
                });

                // Зрачки быстро осматриваются
                document.querySelectorAll('.monster-pupil').forEach(pupil => {
                    pupil.style.animation = 'lookAround 2s infinite';
                });

                // Рот открывается, показывая зубы и язык
                this.elements.monsterMouth.style.height = '15px';
                this.elements.monsterMouth.style.width = '40px';
                this.elements.monsterMouth.style.borderRadius = '10px 10px 20px 20px';
                this.elements.monsterMouth.style.backgroundColor = '#333';

                document.querySelector('.monster-teeth').style.display = 'flex';
                document.querySelector('.monster-tongue').style.display = 'block';

                // Активация обзора монстра и скрытие zZZ
                this.elements.monsterVision.style.display = 'block';
                this.elements.monsterVision.style.animation = 'visionPulse 2s infinite alternate';
                this.elements.monsterSleepText.style.opacity = '0';

                // Вызываем страх у игрока
                this._showFear();

                // Добавляем дрожание монстру для усиления эффекта
                this.activeAnimations.monsterShaking = this.animationEngine.shake(this.elements.monsterContainer, {
                    intensity: 1,
                    frequency: 0.15,
                    duration: 2000,
                    baseTransform: 'translateX(-50%)'
                });

                // Воспроизведение звука пробуждения
                if (this.state.soundEnabled) {
                    // this._playSound('wake');
                }
            }

            /**
             * Активирует режим страха у игрока
             * @param {number} duration - Длительность страха в мс
             * @private
             */
            _showFear(duration = 3000) {
                // Добавление капель пота
                if (!document.querySelector('.sweat-drop')) {
                    const playerHead = this.elements.player.querySelector('.player-head');

                    const sweatLeft = document.createElement('div');
                    sweatLeft.className = 'sweat-drop sweat-drop-left';

                    const sweatRight = document.createElement('div');
                    sweatRight.className = 'sweat-drop sweat-drop-right';

                    playerHead.appendChild(sweatLeft);
                    playerHead.appendChild(sweatRight);
                }

                // Делаем капли пота видимыми
                const sweats = this.elements.player.querySelectorAll('.sweat-drop');
                sweats.forEach(drop => {
                    drop.style.opacity = '1';
                    drop.style.transform = drop.classList.contains('sweat-drop-left') ?
                        'translateY(15px) rotate(-15deg)' : 'translateY(15px) rotate(15deg)';
                });

                // Анимация дрожания игрока
                this.activeAnimations.playerShaking = this.animationEngine.shake(this.elements.player, {
                    intensity: 2.5,
                    frequency: 0.2,
                    duration: duration,
                    baseTransform: 'translateX(-50%)',
                    onComplete: () => this._stopFear()
                });
            }

            /**
             * Отключает режим страха у игрока
             * @private
             */
            _stopFear() {
                if (this.activeAnimations.playerShaking) {
                    this.activeAnimations.playerShaking.stop();
                    delete this.activeAnimations.playerShaking;
                }

                // Скрываем капли пота
                const sweats = this.elements.player.querySelectorAll('.sweat-drop');
                sweats.forEach(drop => {
                    drop.style.opacity = '0';
                    drop.style.transform = '';
                });
            }

            /**
             * Шаг игрока вперед
             * @private
             */
            _playerStep() {
                if (this.state.paused || this.state.gameOver) return;

                if (this.state.monsterAwake) {
                    // Игрок был пойман
                    this._endGame();
                    return;
                }

                // Успешный шаг
                this.state.currentSteps++;

                // Перемещение игрока ближе к монстру
                const progressPercentage = this.state.currentSteps / this.state.stepsNeeded;
                this.elements.player.style.bottom = `${150 - (progressPercentage * 100)}px`;

                // Визуальная обратная связь
                this.elements.player.style.transform = 'translateX(-50%) scale(1.1)';
                this._animateStep();
                this._addPoints(Math.floor(Math.random() * 10) + 1);

                setTimeout(() => {
                    this.elements.player.style.transform = 'translateX(-50%) scale(1)';
                }, 100);

                this._updateUI();

                // Проверка завершения уровня
                if (this.state.currentSteps >= this.state.stepsNeeded) {
                    this._completeLevel();
                }
            }

            /**
             * Анимация шага игрока
             * @private
             */
            _animateStep() {
                this.stepCount++;

                if (this.stepCount % 2 === 0) {
                    this.elements.playerFeetLeft.style.transform = 'rotate(-20deg)';
                    this.elements.playerFeetRight.style.transform = 'rotate(0deg)';
                } else {
                    this.elements.playerFeetLeft.style.transform = 'rotate(0deg)';
                    this.elements.playerFeetRight.style.transform = 'rotate(20deg)';
                }

                // Звук шага
                if (this.state.soundEnabled) {
                    // this._playSound('step');
                }
            }

            /**
             * Добавление очков с анимацией
             * @param {number} amount - Количество очков
             * @param {HTMLElement} sourceElement - Исходный элемент для анимации
             * @private
             */
            _addPoints(amount, sourceElement = null) {
                const pointsElement = document.createElement('div');
                pointsElement.className = 'points';
                pointsElement.textContent = '+' + amount;

                if (sourceElement) {
                    const rect = sourceElement.getBoundingClientRect();
                    pointsElement.style.left = (rect.left + rect.width / 2) + 'px';
                    pointsElement.style.top = rect.top + 'px';
                } else {
                    pointsElement.style.left = (Math.random() * (window.innerWidth - 100) + 50) + 'px';
                    pointsElement.style.top = (Math.random() * (window.innerHeight / 2) + 200) + 'px';
                }

                document.body.appendChild(pointsElement);

                // Анимация
                setTimeout(() => {
                    pointsElement.style.opacity = '1';
                    pointsElement.style.transform = 'translateY(-50px)';
                }, 10);

                setTimeout(() => {
                    pointsElement.style.opacity = '0';
                }, 800);

                setTimeout(() => {
                    pointsElement.remove();
                }, 1000);

                // Обновление счета
                this.state.score += amount;
                this._updateUI();
            }

            /**
             * Завершение текущего уровня
             * @private
             */
            _completeLevel() {
                clearInterval(this.monsterTimer);
                this.elements.monsterSleepText.style.opacity = '0';
                this.state.paused = true;

                // Анимация побежденного монстра
                this.elements.monster.style.transform = 'translateX(-50%) scale(0.8) rotate(180deg)';
                this.elements.monster.style.opacity = '0.5';
                this.elements.monsterMouth.style.height = '2px';

                // Анимация падения монет
                const coinCount = 5 + this.state.level * 2;
                this._createCoins(coinCount);

                // Добавление монет и бонусных очков
                const levelBonus = this.state.level * 50;
                this.state.score += levelBonus;
                this.state.coins += coinCount;

                this._updateUI();

                // Звук завершения уровня
                if (this.state.soundEnabled) {
                    // this._playSound('levelComplete');
                }

                // Запуск следующего уровня после задержки
                setTimeout(() => {
                    this.state.level++;
                    this.state.currentSteps = 0;
                    this.state.stepsNeeded = 10 + (this.state.level - 1) * 5;
                    if (this.state.stepsNeeded > 30) this.state.stepsNeeded = 30;

                    this.state.paused = false;

                    // Сброс позиций игрока и монстра
                    this.elements.player.style.bottom = '150px';
                    this.elements.monster.style.transform = 'translateX(-50%) scale(1)';
                    this.elements.monster.style.opacity = '1';
                    this.elements.monster.style.rotate = '0deg';

                    this._updateUI();
                    this._updateEnvironment();
                    this._startMonsterBehavior();
                    this._showLevelInfo();
                }, 2000);
            }

            /**
             * Создает анимированные монеты
             * @param {number} count - Количество монет
             * @private
             */
            _createCoins(count) {
                for (let i = 0; i < count; i++) {
                    const coin = document.createElement('div');
                    coin.className = 'coins';

                    // Позиционирование монеты рядом с монстром
                    const monsterRect = this.elements.monster.getBoundingClientRect();
                    const randomOffsetX = Math.random() * 80 - 40;
                    const randomOffsetY = Math.random() * 40 - 20;

                    coin.style.left = `${monsterRect.left + monsterRect.width / 2 + randomOffsetX}px`;
                    coin.style.top = `${monsterRect.top + monsterRect.height / 2 + randomOffsetY}px`;

                    this.elements.gameArea.appendChild(coin);

                    // Анимация монеты
                    setTimeout(() => {
                        coin.style.opacity = '1';
                        coin.style.transform = `translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 + 50}px)`;
                    }, i * 50);

                    // Удаление монеты после анимации
                    setTimeout(() => {
                        coin.remove();
                    }, 1500);
                }
            }

            /**
             * Показывает информацию о текущем уровне
             * @private
             */
            _showLevelInfo() {
                this.elements.levelNumber.textContent = this.state.level;
                const levelIndex = Math.min(this.state.level - 1, this.state.levelDescriptions.length - 1);
                this.elements.levelDesc.textContent = this.state.levelDescriptions[levelIndex];

                this.elements.levelInfo.style.opacity = '1';

                setTimeout(() => {
                    this.elements.levelInfo.style.opacity = '0';
                }, 2000);
            }

            /**
             * Заканчивает игру
             * @private
             */
            _endGame() {
                this.state.gameOver = true;
                clearInterval(this.monsterTimer);

                // Анимация того, как монстр ловит игрока
                this.elements.monster.style.transform = 'translateX(-50%) scale(1.5)';
                this.elements.monsterMouth.style.height = '25px';
                this.elements.monsterMouth.style.width = '50px';

                this.elements.player.style.opacity = '0.5';
                this.elements.player.style.transform = 'translateX(-50%) scale(0.8) rotate(180deg)';

                // Звук окончания игры
                if (this.state.soundEnabled) {
                    // this._playSound('gameOver');
                }

                // Показать экран окончания игры
                this.elements.finalScoreElement.textContent = this.state.score;
                this.elements.gameOverScreen.style.opacity = '1';
                this.elements.gameOverScreen.style.pointerEvents = 'auto';
            }

            /**
             * Переключает состояние паузы
             * @private
             */
            _togglePause() {
                this.state.paused = !this.state.paused;
                this.elements.pauseButton.textContent = this.state.paused ? 'Resume' : 'Pause';

                if (!this.state.paused) {
                    // Возобновление поведения монстра
                    this._startMonsterBehavior();
                }
            }

            /**
             * Перезапуск игры
             * @private
             */
            _restartGame() {
                clearInterval(this.monsterTimer);
                this.elements.gameOverScreen.style.opacity = '0';
                this.elements.gameOverScreen.style.pointerEvents = 'none';

                // Сброс позиций игрока и монстра
                this.elements.player.style.bottom = '150px';
                this.elements.player.style.opacity = '1';
                this.elements.player.style.transform = 'translateX(-50%) scale(1)';
                this.elements.playerFeetLeft.style.transform = 'rotate(0deg)';
                this.elements.playerFeetRight.style.transform = 'rotate(0deg)';

                this.elements.monster.style.transform = 'translateX(-50%) scale(1)';
                this.elements.monster.style.opacity = '1';
                this.elements.monsterMouth.style.height = '8px';
                this.elements.monsterMouth.style.width = '40px';

                // Сброс и перезапуск игры
                this._resetGameState();
                this._updateUI();
                this._startMonsterBehavior();
                this._showLevelInfo();
                this._updateEnvironment();
            }

            /**
             * Открывает модальное окно
             * @param {string} modalId - ID модального окна
             * @private
             */
            _openModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.add('show');
                this.state.paused = true;
            }

            /**
             * Закрывает все модальные окна
             * @private
             */
            _closeAllModals() {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.classList.remove('show');
                });
                if (!this.state.gameOver) {
                    this.state.paused = false;
                }
            }

            /**
             * Сохраняет настройки
             * @private
             */
            _saveSettings() {
                this.state.soundEnabled = this.elements.soundToggle.checked;
                this.state.difficulty = this.elements.difficultySelect.value;

                // Добавьте эту строчку:
                this.state.useBackgroundImages = document.getElementById('background-toggle').checked;

                // Если игра в процессе, обновляем поведение монстра для новой сложности
                if (!this.state.gameOver) {
                    this._startMonsterBehavior();
                    this._updateUI(); // Обновляем UI чтобы применить изменения фона
                }

                this._closeAllModals();
            }

            /**
             * Воспроизводит звук
             * @param {string} soundType - Тип звука
             * @private
             */
            _playSound(soundType) {
                // Заглушка для воспроизведения звуков
                // В реальной реализации здесь был бы код для воспроизведения звуков
                console.log(`Playing ${soundType} sound`);
            }
        }

        // Инициализация игры при загрузке страницы
        window.addEventListener('DOMContentLoaded', () => {
            const game = new MonsterRunnerGame();
            game.init();
        });
    </script>
</body>

</html>